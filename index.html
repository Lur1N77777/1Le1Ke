<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>摄影师档期预约</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Day.js 用于日期处理 -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
    <!-- 引入 LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4/dist/av-live-query-min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- 引入一个柔和的字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Inter:wght@400;500;700&family=Noto+Sans+SC:wght@300;400;500;700&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <style>
        /* 自定义样式和马卡龙配色 */
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: #fdf6f7; /* 淡粉色背景 */
        }
        .macaron-pink { background-color: #f8d5e1; color: #8c5d6e; }
        .macaron-blue { background-color: #d1e5f0; color: #5a7a8b; }
        .macaron-green { background-color: #d4ece5; color: #5d8b7e; }
        .macaron-yellow { background-color: #fef4d8; color: #a38c4c; }
        .macaron-purple { background-color: #e8e0f1; color: #7b6a8b; }

        .btn-primary {
            background-color: #f8d5e1;
            color: #8c5d6e;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .calendar-day.today {
            background-color: #f8d5e1;
            border-radius: 50%;
            color: #fff;
        }
        
        .calendar-day.unavailable {
            background-color: #e5e7eb;
            color: #9ca3af;
            text-decoration: line-through;
            cursor: not-allowed;
            pointer-events: none;
        }

        .status-pending { background-color: #fef4d8 !important; color: #a38c4c !important; cursor: not-allowed; }
        .status-confirmed { background-color: #f8a5c2 !important; color: #ffffff !important; cursor: not-allowed; }
        
        .admin-mode .status-pending, .admin-mode .status-confirmed { cursor: pointer; }
        
        .editable {
            transition: all 0.3s ease;
            padding: 2px 5px;
            border-radius: 6px;
        }
        .admin-mode .editable:hover {
            background-color: rgba(254, 244, 216, 0.7);
            outline: 2px dashed #f8d5e1;
        }
        [contenteditable="true"] {
            outline: 2px solid #f8a5c2;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            align-items: center;
            justify-content: center;
        }
        .modal.flex {
            display: flex;
        }
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 40;
        }
        .modal-content {
            z-index: 50;
        }
        
        .multi-select-day.selected {
            background-color: #3b82f6 !important;
            color: white !important;
            border-radius: 50%;
        }

        #photographerName {
            font-family: 'ZCOOL KuaiLe', cursive;
            font-weight: 400; 
        }
        .brand-font {
            font-family: 'Dancing Script', cursive;
            font-size: 1.25rem; 
            color: #d1c4e9; 
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23f8d5e1' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            z-index: -1;
        }
    </style>
</head>
<body class="antialiased text-gray-700">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">

        <header class="text-center mb-8 md:mb-12">
            <h1 id="photographerName" class="text-4xl md:text-5xl font-bold text-gray-800 editable">摄影师的名字</h1>
            <p id="introText" class="mt-4 text-lg text-gray-500 max-w-2xl mx-auto editable">
                欢迎来到我的预约页面！在这里您可以查看我的档期并选择您心仪的拍摄时间。期待与您一同创作美好的回忆。
            </p>
        </header>
        
        <div id="admin-controls" class="text-center mb-6 hidden flex-wrap justify-center gap-4">
             <button id="save-content-btn" class="px-6 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition-all">保存页面文字</button>
             <button id="manage-unavailable-btn" class="px-6 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-all">管理不可预约日期</button>
             <button id="admin-logout-btn" class="px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-all">退出站长模式</button>
        </div>

        <main class="bg-white/80 backdrop-blur-sm p-6 md:p-8 rounded-2xl shadow-lg">
            <div class="md:grid md:grid-cols-2 md:gap-8">
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h2 id="current-month-year" class="text-xl font-semibold text-gray-800"></h2>
                        <button id="next-month" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div id="calendar" class="grid grid-cols-7 gap-1 text-center">
                    </div>
                </div>

                <div id="time-slots-container" class="mt-8 md:mt-0">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">选择时间段</h3>
                    <p id="selected-date-display" class="text-gray-500 mb-4">请先在左侧选择一个日期</p>
                    <div id="time-slots" class="grid grid-cols-2 gap-3">
                    </div>
                </div>
            </div>
             <div class="mt-8 text-center text-sm text-gray-500">
                <span class="inline-block w-4 h-4 rounded-full bg-gray-300 mr-2 border"></span> 不可预约
                <span class="inline-block w-4 h-4 rounded-full bg-yellow-300 ml-4 mr-2"></span> 待确认
                <span class="inline-block w-4 h-4 rounded-full bg-red-400 ml-4 mr-2"></span> 已预约
            </div>
        </main>
        
        <footer class="text-center mt-8 text-gray-400">
            <p class="flex items-center justify-center space-x-2">
                <span class="brand-font">Powered by LouYile.</span>
                <a href="#" id="admin-login-btn" class="hover:text-gray-600 text-sm">大摄影师小一入口</a>
            </p>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="setup-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
             <h2 class="text-2xl font-bold text-red-500 mb-4">网站未配置！</h2>
             <p class="text-gray-600">您需要先在HTML代码中填入您的LeanCloud应用配置信息，网站才能正常工作。<br><br>请打开 <strong>index.html</strong> 文件，找到 <strong>`// --- LeanCloud 配置区域 ---`</strong> 部分，然后用您自己的信息替换占位符。</p>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">站长登录</h2>
            <input type="password" id="admin-password" placeholder="请输入密码" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-f8d5e1 focus:border-transparent outline-none">
            <div class="mt-6 flex justify-end space-x-4">
                <button data-close-modal="admin-modal" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">取消</button>
                <button id="submit-admin-login" class="px-6 py-2 btn-primary rounded-lg font-semibold shadow-md">登录</button>
            </div>
        </div>
    </div>
    
    <div id="booking-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">预约信息</h2>
            <p id="booking-modal-time" class="text-gray-600 mb-6"></p>
            <form id="booking-form">
                <div class="mb-4"><label for="client-name" class="block text-sm font-medium text-gray-700 mb-1">您的称呼</label><input type="text" id="client-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-f8d5e1 focus:border-transparent outline-none"></div>
                <div class="mb-4"><label for="client-contact" class="block text-sm font-medium text-gray-700 mb-1">联系方式 (微信/电话)</label><input type="text" id="client-contact" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-f8d5e1 focus:border-transparent outline-none"></div>
                <div class="mb-4"><label for="client-notes" class="block text-sm font-medium text-gray-700 mb-1">备注 (选填)</label><textarea id="client-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-f8d5e1 focus:border-transparent outline-none"></textarea></div>
                <div class="mt-6 flex justify-end space-x-4"><button type="button" data-close-modal="booking-modal" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">取消</button><button type="submit" class="px-6 py-2 btn-primary rounded-lg font-semibold shadow-md">提交预约</button></div>
            </form>
        </div>
    </div>

    <div id="admin-action-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">管理预约</h2>
            <div id="admin-booking-info" class="space-y-2 text-gray-700 mb-6"></div>
            <div class="mt-6 flex justify-between">
                <button id="delete-booking-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-semibold">删除预约</button>
                <div class="space-x-4"><button data-close-modal="admin-action-modal" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">取消</button><button id="confirm-booking-btn" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-semibold">确认档期</button></div>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-xl font-bold text-gray-800 mb-4">请确认</h2>
            <p id="confirm-modal-message" class="text-gray-600 mb-6"></p>
            <div class="mt-6 flex justify-end space-x-4"><button id="confirm-modal-cancel" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">取消</button><button id="confirm-modal-confirm" class="px-6 py-2 bg-red-500 text-white rounded-lg font-semibold shadow-md">确认</button></div>
        </div>
    </div>

    <div id="unavailable-dates-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">选择不可预约日期</h2>
            <p class="text-sm text-gray-500 mb-4">点击日期进行选择或取消。您可以跨月份选择。</p>
             <div>
                <div class="flex items-center justify-between mb-4"><button id="unavailable-prev-month" class="p-2 rounded-full hover:bg-gray-100 transition-colors"><svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button><h2 id="unavailable-month-year" class="text-xl font-semibold text-gray-800"></h2><button id="unavailable-next-month" class="p-2 rounded-full hover:bg-gray-100 transition-colors"><svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button></div>
                <div id="unavailable-calendar" class="grid grid-cols-7 gap-1 text-center"></div>
            </div>
            <div class="mt-6 flex justify-end space-x-4"><button data-close-modal="unavailable-dates-modal" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">取消</button><button id="save-unavailable-dates" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-semibold shadow-md">保存设置</button></div>
        </div>
    </div>

    <div id="cancellation-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">我的预约</h2>
            <p class="text-gray-600 mb-6">您已预约此时间段。如果您想取消，请点击下面的按钮。</p>
            <div id="cancellation-booking-info" class="space-y-2 text-gray-700 mb-6 bg-gray-50 p-4 rounded-lg"></div>
            <div class="mt-6 flex justify-end space-x-4"><button data-close-modal="cancellation-modal" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">保留预约</button><button id="cancel-booking-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-semibold">确认取消</button></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 right-10 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl translate-x-[150%] transition-transform duration-500">
        <p id="toast-message"></p>
    </div>

    <script type="module">
        dayjs.extend(window.dayjs_plugin_utc);
        dayjs.extend(window.dayjs_plugin_timezone);

        // --- LeanCloud 配置区域 ---
        const LEANCLOUD_APP_ID = "fnI1W7pmpDuCu006VVyC8jxe-gzGzoHsz";
        const LEANCLOUD_APP_KEY = "FNZjeEMp0nrh9JYA9jo1tUto";
        const LEANCLOUD_SERVER_URL = "https://fni1w7pm.lc-cn-n1-shared.com";
        
        const ADMIN_PASSWORD = "0624";
        const AVAILABLE_TIMES = [ "09:00 - 11:00", "13:00 - 17:00", "19:00 - 21:00" ];
        
        let currentMonth = dayjs();
        let selectedDate = null;
        let bookings = [];
        let isAdmin = false;
        let siteContent = null; 
        let unavailableDates = [];
        let unavailableCalendarMonth = dayjs();
        let tempUnavailableDates = [];
        
        const calendarEl = document.getElementById('calendar');
        const currentMonthYearEl = document.getElementById('current-month-year');
        const timeSlotsContainer = document.getElementById('time-slots');
        const selectedDateDisplay = document.getElementById('selected-date-display');

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.classList.remove('translate-x-[150%]');
            setTimeout(() => {
                toast.classList.add('translate-x-[150%]');
            }, 3000);
        }

        function renderCalendar() {
            calendarEl.innerHTML = '';
            currentMonthYearEl.textContent = currentMonth.format('YYYY年 MMMM');
            
            const startOfMonth = currentMonth.startOf('month');
            const daysInMonth = currentMonth.daysInMonth();
            const startDayOfWeek = startOfMonth.day();

            ['日', '一', '二', '三', '四', '五', '六'].forEach(day => {
                calendarEl.innerHTML += `<div class="font-semibold text-gray-600 text-sm">${day}</div>`;
            });
            
            for (let i = 0; i < startDayOfWeek; i++) { calendarEl.innerHTML += `<div></div>`; }

            for (let i = 1; i <= daysInMonth; i++) {
                const date = currentMonth.date(i);
                const dateStr = date.format('YYYY-MM-DD');
                const dayEl = document.createElement('div');
                dayEl.textContent = i;
                dayEl.className = 'calendar-day p-2 cursor-pointer rounded-full transition-colors hover:bg-gray-200';
                dayEl.dataset.date = dateStr;

                if (unavailableDates.includes(dateStr)) {
                    dayEl.classList.add('unavailable');
                    calendarEl.appendChild(dayEl);
                    continue; 
                }

                if (date.isSame(dayjs(), 'day')) { dayEl.classList.add('today'); }
                
                if (date.isBefore(dayjs(), 'day')) {
                     dayEl.classList.add('text-gray-300', 'cursor-not-allowed', 'hover:bg-transparent', 'pointer-events-none');
                } else {
                    dayEl.addEventListener('click', () => {
                        selectedDate = dateStr;
                        document.querySelectorAll('.calendar-day.bg-blue-200').forEach(el => el.classList.remove('bg-blue-200'));
                        dayEl.classList.add('bg-blue-200');
                        renderTimeSlots();
                    });
                }
                
                const dayBookings = bookings.filter(b => b.date === dateStr);
                if (dayBookings.length > 0) {
                   const isFullyBooked = dayBookings.length >= AVAILABLE_TIMES.length;
                   const hasConfirmed = dayBookings.some(b => b.status === 'confirmed');
                   const hasPending = dayBookings.some(b => b.status === 'pending');
                   
                   if(isFullyBooked || hasConfirmed) {
                       dayEl.classList.add('macaron-pink', 'text-white', 'font-bold');
                   } else if(hasPending) {
                       dayEl.classList.add('macaron-yellow');
                   }
                }

                calendarEl.appendChild(dayEl);
            }
        }
        
        function renderTimeSlots() {
            if (!selectedDate || unavailableDates.includes(selectedDate)) {
                selectedDateDisplay.textContent = unavailableDates.includes(selectedDate) ? '此日期不可预约' : '请先在左侧选择一个日期';
                timeSlotsContainer.innerHTML = '';
                return;
            }

            selectedDateDisplay.textContent = `已选日期: ${selectedDate}`;
            timeSlotsContainer.innerHTML = '';

            AVAILABLE_TIMES.forEach(time => {
                const timeSlotEl = document.createElement('button');
                timeSlotEl.textContent = time;
                timeSlotEl.className = 'p-3 rounded-lg text-center transition-all btn-primary shadow-sm';
                timeSlotEl.dataset.time = time;
                
                const booking = bookings.find(b => b.date === selectedDate && b.time === time);
                
                if (booking) {
                    timeSlotEl.classList.remove('btn-primary');
                    if (booking.status === 'pending') {
                        timeSlotEl.classList.add('status-pending');
                        timeSlotEl.textContent = `${time} (待确认)`;
                    } else if (booking.status === 'confirmed') {
                        timeSlotEl.classList.add('status-confirmed');
                        timeSlotEl.textContent = `${time} (已预约)`;
                    }
                    timeSlotEl.disabled = !isAdmin && booking.status === 'confirmed';
                }
                
                timeSlotEl.addEventListener('click', () => handleTimeSlotClick(time, booking));
                timeSlotsContainer.appendChild(timeSlotEl);
            });
        }
        
        function handleTimeSlotClick(time, booking) {
            if (isAdmin) {
                if (booking) { openAdminActionModal(booking); } 
                else { showToast('该时间段无预约'); }
            } else {
                if (!booking) { 
                    openBookingModal(selectedDate, time); 
                } else if (booking.status === 'pending') {
                    const ownerIds = JSON.parse(localStorage.getItem('myBookingIds') || '[]');
                    if (ownerIds.includes(booking.ownerId)) {
                        openCancellationModal(booking);
                    } else {
                        showToast('此时间段正在等待确认');
                    }
                }
            }
        }

        function openModal(modalId) { document.getElementById(modalId).classList.add('flex'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('flex'); }
        
        function openBookingModal(date, time) {
            document.getElementById('booking-modal-time').textContent = `预约: ${date} ${time}`;
            document.getElementById('booking-form').dataset.date = date;
            document.getElementById('booking-form').dataset.time = time;
            openModal('booking-modal');
        }
        
        function openAdminActionModal(booking) {
             const infoEl = document.getElementById('admin-booking-info');
             infoEl.innerHTML = `<p><strong>日期:</strong> ${booking.date}</p><p><strong>时间:</strong> ${booking.time}</p><p><strong>客户:</strong> ${booking.clientName}</p><p><strong>联系方式:</strong> ${booking.clientContact}</p><p><strong>备注:</strong> ${booking.notes || '无'}</p><p><strong>状态:</strong> <span class="px-2 py-1 rounded-full text-sm ${booking.status === 'pending' ? 'macaron-yellow' : 'macaron-pink'}">${booking.status === 'pending' ? '待确认' : '已确认'}</span></p>`;
            document.getElementById('confirm-booking-btn').style.display = booking.status === 'pending' ? 'inline-block' : 'none';
            document.getElementById('confirm-booking-btn').onclick = () => confirmBooking(booking.id);
            document.getElementById('delete-booking-btn').onclick = () => deleteBooking(booking.id);
            openModal('admin-action-modal');
        }
        
        function openCancellationModal(booking) {
             const infoEl = document.getElementById('cancellation-booking-info');
             infoEl.innerHTML = `<p><strong>日期:</strong> ${booking.date}</p><p><strong>时间:</strong> ${booking.time}</p><p><strong>您的称呼:</strong> ${booking.clientName}</p>`;
            document.getElementById('cancel-booking-btn').onclick = () => {
                 closeModal('cancellation-modal');
                 showConfirm('您确定要取消这个预约吗？', () => {
                    clientDeleteBooking(booking);
                 });
            };
            openModal('cancellation-modal');
        }

        async function submitBooking(event) {
            event.preventDefault();
            const form = event.target;
            const ownerId = crypto.randomUUID(); 
            
            const Booking = AV.Object.extend('Booking');
            const newBooking = new Booking();
            newBooking.set('date', form.dataset.date);
            newBooking.set('time', form.dataset.time);
            newBooking.set('clientName', document.getElementById('client-name').value.trim());
            newBooking.set('clientContact', document.getElementById('client-contact').value.trim());
            newBooking.set('notes', document.getElementById('client-notes').value.trim());
            newBooking.set('status', 'pending');
            newBooking.set('ownerId', ownerId);

            try {
                await newBooking.save();
                let ownerIds = JSON.parse(localStorage.getItem('myBookingIds') || '[]');
                ownerIds.push(ownerId);
                localStorage.setItem('myBookingIds', JSON.stringify(ownerIds));
                showToast('预约请求已发送！');
                form.reset(); closeModal('booking-modal');
            } catch (error) { console.error("Error adding document: ", error); showToast('抱歉，出错了，请稍后再试。'); }
        }

        async function confirmBooking(bookingId) {
            try {
                const bookingToUpdate = AV.Object.createWithoutData('Booking', bookingId);
                bookingToUpdate.set('status', 'confirmed');
                await bookingToUpdate.save();
                showToast('档期已确认！'); closeModal('admin-action-modal');
            } catch (error) { console.error("Error updating document: ", error); showToast('确认失败，请重试。'); }
        }

        function showConfirm(message, onConfirm) {
            const confirmModal = document.getElementById('confirm-modal');
            const messageEl = document.getElementById('confirm-modal-message');
            const confirmBtn = document.getElementById('confirm-modal-confirm');
            const cancelBtn = document.getElementById('confirm-modal-cancel');
            messageEl.textContent = message;
            const confirmHandler = () => { onConfirm(); closeModal('confirm-modal'); cleanup(); };
            const cancelHandler = () => { closeModal('confirm-modal'); cleanup(); };
            const cleanup = () => {
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            }
            confirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', cancelHandler, { once: true });
            openModal('confirm-modal');
        }

        function deleteBooking(bookingId) {
            showConfirm('确定要删除此预约吗？此操作无法撤销。', async () => {
                try {
                    const bookingToDelete = AV.Object.createWithoutData('Booking', bookingId);
                    await bookingToDelete.destroy();
                    showToast('预约已删除。'); closeModal('admin-action-modal');
                } catch (error) { console.error("Error deleting document: ", error); showToast('删除失败，请重试。'); }
            });
        }
        
        async function clientDeleteBooking(booking) {
            try {
                const bookingToDelete = AV.Object.createWithoutData('Booking', booking.id);
                await bookingToDelete.destroy();
                let ownerIds = JSON.parse(localStorage.getItem('myBookingIds') || '[]');
                ownerIds = ownerIds.filter(id => id !== booking.ownerId);
                localStorage.setItem('myBookingIds', JSON.stringify(ownerIds));
                showToast('预约已成功取消。');
            } catch (error) { console.error("Error deleting document: ", error); showToast('取消失败，请重试。'); }
        }
        
        async function saveSiteContent() {
            const currentUser = AV.User.current();
            if (!currentUser || !isAdmin) {
                showToast('需要管理员权限才能保存！');
                return;
            }
            if (!siteContent || typeof siteContent.set !== 'function') {
                const SiteContent = AV.Object.extend('SiteContent');
                siteContent = new SiteContent();
                const acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setWriteAccess(currentUser, true);
                siteContent.setACL(acl);
            }
            siteContent.set('photographerName', document.getElementById('photographerName').textContent);
            siteContent.set('introText', document.getElementById('introText').textContent);
            
            try {
                await siteContent.save();
                showToast('页面内容已保存！'); 
                toggleEditable(false);
            } catch (error) { console.error("Error saving site content: ", error); showToast('保存失败，请重试。'); }
        }
        
        async function handleAdminLogin() {
            const password = document.getElementById('admin-password').value;
            const username = 'admin'; // Hardcoded admin username

            try {
                if (AV.User.current()) { await AV.User.logOut(); }
                const adminUser = await AV.User.logIn(username, password);
                isAdmin = true;
                sessionStorage.setItem('isAdmin', 'true');
                sessionStorage.setItem('adminToken', adminUser.getSessionToken());
                
                enableAdminMode();
                closeModal('admin-modal');
                document.getElementById('admin-password').value = '';
                showToast('欢迎回来，站长！');
            } catch (error) {
                showToast('登录失败！请检查密码或确保管理员账户存在。');
                console.error('Admin login failed:', error);
                await AV.User.loginAnonymously();
            }
        }

        function enableAdminMode() {
            document.body.classList.add('admin-mode');
            document.getElementById('admin-controls').style.display = 'flex';
            toggleEditable(true); 
            if(selectedDate) renderTimeSlots();
        }
        
        async function handleAdminLogout() {
            await AV.User.logOut();
            sessionStorage.removeItem('isAdmin');
            sessionStorage.removeItem('adminToken');
            isAdmin = false;
            document.body.classList.remove('admin-mode');
            document.getElementById('admin-controls').style.display = 'none';
            toggleEditable(false);
            showToast('已退出站长模式。');
            await AV.User.loginAnonymously();
            renderCalendar();
            if (selectedDate) renderTimeSlots();
        }


        function toggleEditable(isEditable) { document.querySelectorAll('.editable').forEach(el => { el.contentEditable = isEditable; }); }
        
        function openUnavailableDatesModal() {
            tempUnavailableDates = [...unavailableDates]; 
            unavailableCalendarMonth = dayjs();
            renderUnavailableCalendar();
            openModal('unavailable-dates-modal');
        }

        function renderUnavailableCalendar() {
            const calendarContainer = document.getElementById('unavailable-calendar');
            calendarContainer.innerHTML = '';
            document.getElementById('unavailable-month-year').textContent = unavailableCalendarMonth.format('YYYY年 MMMM');
            
            const startOfMonth = unavailableCalendarMonth.startOf('month');
            const daysInMonth = unavailableCalendarMonth.daysInMonth();
            const startDayOfWeek = startOfMonth.day();

            ['日', '一', '二', '三', '四', '五', '六'].forEach(day => {
                calendarContainer.innerHTML += `<div class="font-semibold text-gray-400 text-xs">${day}</div>`;
            });
            
            for (let i = 0; i < startDayOfWeek; i++) { calendarContainer.innerHTML += `<div></div>`; }

            for (let i = 1; i <= daysInMonth; i++) {
                const date = unavailableCalendarMonth.date(i);
                const dateStr = date.format('YYYY-MM-DD');
                const dayEl = document.createElement('div');
                dayEl.textContent = i;
                dayEl.className = 'multi-select-day p-2 cursor-pointer rounded-full transition-colors hover:bg-gray-200';
                
                if (tempUnavailableDates.includes(dateStr)) {
                    dayEl.classList.add('selected');
                }

                dayEl.addEventListener('click', () => {
                    if (tempUnavailableDates.includes(dateStr)) {
                        tempUnavailableDates = tempUnavailableDates.filter(d => d !== dateStr);
                        dayEl.classList.remove('selected');
                    } else {
                        tempUnavailableDates.push(dateStr);
                        dayEl.classList.add('selected');
                    }
                });
                calendarContainer.appendChild(dayEl);
            }
        }
        
        async function saveUnavailableDates() {
            const currentUser = AV.User.current();
            if (!currentUser || !isAdmin) {
                showToast('需要管理员权限才能保存！');
                return;
            }
            if (!siteContent || typeof siteContent.set !== 'function') {
                const SiteContent = AV.Object.extend('SiteContent');
                siteContent = new SiteContent();
                const acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setWriteAccess(currentUser, true);
                siteContent.setACL(acl);
            }
            siteContent.set('unavailableDates', tempUnavailableDates);
            try {
                await siteContent.save();
                showToast('不可预约日期已更新！');
                closeModal('unavailable-dates-modal');
            } catch (error) { console.error("Error saving unavailable dates: ", error); showToast('保存失败，请重试。'); }
        }

        function updateUIWithSiteContent(content) {
            siteContent = content; // Store the object
            const data = content.attributes;
            document.getElementById('photographerName').textContent = data.photographerName || '摄影师的名字';
            document.getElementById('introText').textContent = data.introText || '欢迎来到我的预约页面！在这里您可以查看我的档期并选择您心仪的拍摄时间。期待与您一同创作美好的回忆。';
            unavailableDates = data.unavailableDates || [];
            renderCalendar(); 
            if(selectedDate) renderTimeSlots();
        }

        function processBookingUpdate(bookingObject) {
            const bookingData = { id: bookingObject.id, ...bookingObject.attributes };
            const index = bookings.findIndex(b => b.id === bookingData.id);
            if (index > -1) {
                bookings[index] = bookingData;
            } else {
                bookings.push(bookingData);
            }
        }
        
        async function loadDataAndSubscribe() {
            try {
                const bookingQuery = new AV.Query('Booking');
                const initialBookings = await bookingQuery.find();
                bookings = initialBookings.map(b => ({ id: b.id, ...b.attributes }));

                const contentQuery = new AV.Query('SiteContent');
                const initialContent = await contentQuery.first();
                if (initialContent) {
                    updateUIWithSiteContent(initialContent);
                } else {
                    updateUIWithSiteContent({ attributes: {} });
                }
                
                const bookingLiveQuery = await bookingQuery.subscribe();
                bookingLiveQuery.on('create', (booking) => { processBookingUpdate(booking); renderCalendar(); if(selectedDate) renderTimeSlots(); });
                bookingLiveQuery.on('update', (booking) => { processBookingUpdate(booking); renderCalendar(); if(selectedDate) renderTimeSlots(); });
                bookingLiveQuery.on('delete', (booking) => {
                    bookings = bookings.filter(b => b.id !== booking.id);
                    renderCalendar();
                    if(selectedDate) renderTimeSlots();
                });
                
                const contentLiveQuery = await contentQuery.subscribe();
                contentLiveQuery.on('update', (content) => { updateUIWithSiteContent(content); });
                contentLiveQuery.on('create', (content) => { updateUIWithSiteContent(content); });

            } catch (error) {
                console.error("Data subscription failed: ", error);
                showToast("无法加载实时数据，请刷新页面");
            }
        }

        async function main() {
            try {
                AV.init({
                    appId: LEANCLOUD_APP_ID,
                    appKey: LEANCLOUD_APP_KEY,
                    serverURL: LEANCLOUD_SERVER_URL,
                });
            } catch(e) { console.error("LeanCloud initialization failed:", e); }

            const adminToken = sessionStorage.getItem('adminToken');
            if (adminToken) {
                try {
                    await AV.User.become(adminToken);
                    isAdmin = true;
                } catch (e) {
                    sessionStorage.removeItem('adminToken');
                }
            }

            if (!AV.User.current()) {
                try {
                    await AV.User.loginAnonymously();
                } catch (e) {
                    console.error('Anonymous login failed!', e);
                    showToast('无法连接到服务器');
                    return;
                }
            }

            await loadDataAndSubscribe();

            if(isAdmin) {
                sessionStorage.setItem('isAdmin', 'true');
                enableAdminMode();
            }
            renderCalendar();
        }

        document.getElementById('prev-month').addEventListener('click', () => { currentMonth = currentMonth.subtract(1, 'month'); renderCalendar(); });
        document.getElementById('next-month').addEventListener('click', () => { currentMonth = currentMonth.add(1, 'month'); renderCalendar(); });
        document.getElementById('admin-login-btn').addEventListener('click', (e) => { e.preventDefault(); openModal('admin-modal'); });
        document.getElementById('submit-admin-login').addEventListener('click', handleAdminLogin);
        document.getElementById('admin-password').addEventListener('keyup', (e) => { if (e.key === 'Enter') handleAdminLogin(); });
        document.getElementById('booking-form').addEventListener('submit', submitBooking);
        document.getElementById('save-content-btn').addEventListener('click', saveSiteContent);
        document.getElementById('manage-unavailable-btn').addEventListener('click', openUnavailableDatesModal);
        document.getElementById('unavailable-prev-month').addEventListener('click', () => { unavailableCalendarMonth = unavailableCalendarMonth.subtract(1, 'month'); renderUnavailableCalendar(); });
        document.getElementById('unavailable-next-month').addEventListener('click', () => { unavailableCalendarMonth = unavailableCalendarMonth.add(1, 'month'); renderUnavailableCalendar(); });
        document.getElementById('save-unavailable-dates').addEventListener('click', saveUnavailableDates);
        document.getElementById('admin-logout-btn').addEventListener('click', handleAdminLogout);
        document.querySelectorAll('[data-close-modal]').forEach(el => { el.addEventListener('click', () => closeModal(el.dataset.closeModal)); });
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            const modal = backdrop.parentElement;
            if (modal.id !== 'setup-modal') {
                 modal.addEventListener('click', (e) => { if (e.target === backdrop.parentElement) { closeModal(modal.id); } });
            }
        });

        main();

    </script>
</body>
</html>



